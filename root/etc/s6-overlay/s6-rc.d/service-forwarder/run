#!/command/with-contenv bash
# shellcheck shell=bash

# shellcheck source=/dev/null
source /etc/s6-overlay/scripts/general-functions

umask "${UMASK}"

if [[ -n ${VPN_AUTO_PORT_FORWARD_TO_PORTS} ]]; then
    VPN_PORT_REDIRECTS=${VPN_AUTO_PORT_FORWARD_TO_PORTS}
    log_wrn "[FORWARDER] The variable [VPN_AUTO_PORT_FORWARD_TO_PORTS] is deprecated in favor of [VPN_PORT_REDIRECTS], please adjust your config!"
fi

re='^[0-9]+$'
if [[ "${VPN_AUTO_PORT_FORWARD}" =~ $re ]]; then
    echo "${VPN_AUTO_PORT_FORWARD}" > "${CONFIG_DIR}/wireguard/forwarded_port"
else
    log_inf "[FORWARDER] Waiting 10s on initial forwarded port update..."
    sleep 10
fi

old_port="0"
while true; do
    if [[ -f "${CONFIG_DIR}/wireguard/forwarded_port" ]]; then
        port=$(sed -n '1p' "${CONFIG_DIR}/wireguard/forwarded_port")
        if [[ "${old_port}" != "${port}" ]] && [[ "${port}" =~ $re ]]; then
            log_inf "[FORWARDER] Forwarded port is [${port}]."
            IFS=',' read -ra forward_ports <<< "${VPN_PORT_REDIRECTS%,}"
            for forward_port in "${forward_ports[@]}"; do
                forward_port="${forward_port// /}"
                internal="${forward_port##*@}"
                if [[ ! ${forward_port} =~ "@" ]]; then
                    port_is_redirected="true"
                    del_rule_redirect_port "${old_port}" "${internal}"
                    add_rule_redirect_port "${port}" "${internal}"
                    add_rule_expose_port "${internal}"
                fi
            done
            if [[ "${port_is_redirected}" != "true" ]]; then
                del_rule_expose_port "${old_port}/tcp"
                del_rule_expose_port "${old_port}/udp"
                add_rule_expose_port "${port}/tcp"
                add_rule_expose_port "${port}/udp"
            fi
            # shellcheck source=/dev/null
            source "${APP_DIR}/forwarded_port_update_app"
            if [[ -f "${CONFIG_DIR}/wireguard/${VPN_CONF}-port.sh" ]]; then
                log_inf "[FORWARDER] Script [${CONFIG_DIR}/wireguard/${VPN_CONF}-port.sh] found. Executing..."
                bash "${CONFIG_DIR}/wireguard/${VPN_CONF}-port.sh"
            fi
            old_port="${port}"
        fi
    fi
    sleep 60
done
